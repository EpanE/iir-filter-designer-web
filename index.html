<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IIR Speech Filter (Web)</title>

  <!-- PWA + Icons -->
  <link rel="manifest" href="manifest.webmanifest?v=3" />
  <meta name="theme-color" content="#0b1220" />
  <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32.png" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <style>
    :root{
      --bg:#0b1220; --card:#121a2b; --text:#e2e8f0; --muted:#94a3b8; --accent:#60a5fa; --border:rgba(255,255,255,.06);
      --card2:#0e1626;
    }
    :root[data-theme="light"]{
      --bg:#f7fafc; --card:#ffffff; --text:#0f172a; --muted:#475569; --border:#e2e8f0; --card2:#f1f5f9;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .title{margin:0;font-size:28px;font-weight:800}
    .sub{margin:8px 0 16px;color:var(--muted)}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
    .grid{display:grid;gap:12px}
    .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input[type="number"], select{width:100%;box-sizing:border-box;background:var(--card2);border:1px solid var(--border);color:var(--text);border-radius:10px;padding:8px 10px}
    .controls{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin-top:8px}
    .check{display:flex;align-items:center;gap:8px;background:var(--card2);border:1px solid var(--border);padding:10px;border-radius:10px}
    button{background:linear-gradient(180deg,#1e3a8a,#1d4ed8);border:none;color:#fff;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
    button.secondary{background:var(--card2);border:1px solid var(--border);color:var(--text)}
    button.small{padding:8px 10px}
    button:disabled{opacity:.5;cursor:not-allowed}
    .status{margin-top:8px;color:var(--muted)}
    .plots{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
    .plot{background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:8px}
    canvas{width:100%;height:240px;background:var(--card2);border-radius:8px}
    #response{height:220px}
    #phase{height:180px}
    /* Help modal */
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:14px;padding:16px;max-width:760px;width:92%}
    .modal h2{margin:0 0 8px}
    .modal p,.modal li{color:var(--muted)}
    .modal .actions{display:flex;justify-content:flex-end;margin-top:12px}
    @media (max-width:900px){ .grid.cols-4{grid-template-columns:1fr 1fr} .plots{grid-template-columns:1fr} }
    @media (max-width:540px){ .grid.cols-4{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row">
      <h1 class="title">IIR Speech Filter (Web)</h1>
      <div style="display:flex;gap:8px;">
        <button id="helpBtn" class="secondary small">Help</button>
        <button id="themeBtn" class="secondary small">Light</button>
      </div>
    </div>
    <p class="sub">Real-time HP/LP cascade + notch, live spectrogram & waveform, presets, WAV recording, and offline PWA.</p>

    <div class="card">
      <div class="grid cols-4">
        <div><label>Lowcut (Hz)</label><input id="lowcut" type="number" value="300" step="10" min="20" max="10000"></div>
        <div><label>Highcut (Hz)</label><input id="highcut" type="number" value="3400" step="10" min="100" max="20000"></div>
        <div><label>LP-only cutoff (Hz)</label><input id="lpCut" type="number" value="4000" step="50" min="100" max="20000"></div>
        <div><label>WAV sample rate</label>
          <select id="wavRate">
            <option value="auto">Auto (native)</option>
            <option value="16000">16000 Hz</option>
          </select>
        </div>
      </div>

      <div class="grid cols-4" style="margin-top:8px;">
        <div><label>HP Order</label>
          <select id="hpOrder">
            <option>2</option><option selected>4</option><option>6</option><option>8</option>
          </select>
        </div>
        <div><label>LP Order</label>
          <select id="lpOrder">
            <option>2</option><option selected>4</option><option>6</option><option>8</option>
          </select>
        </div>
        <div><label>Notch freq (Hz)</label><input id="notchF" type="number" value="50" step="1" min="40" max="2000"></div>
        <div><label>Notch Q</label><input id="notchQ" type="number" value="30" step="1" min="1" max="100"></div>
      </div>

      <div class="controls">
        <label class="check"><input id="enableFilter" type="checkbox" checked> Enable IIR Filter</label>
        <label class="check"><input id="lpOnly" type="checkbox"> Lowpass Only</label>
        <label class="check"><input id="enableNotch" type="checkbox"> Apply Notch</label>
        <label class="check"><input id="showPhase" type="checkbox" checked> Show Phase Response</label>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
        <button id="startBtn">Start Mic</button>
        <button id="stopBtn" class="secondary" disabled>Stop</button>
        <button id="telBtn" class="secondary">Telephone</button>
        <button id="podBtn" class="secondary">Podcast</button>
        <button id="recBtn" class="secondary">Start Recording</button>
        <button id="saveBtn" class="secondary" disabled>Save Recordings</button>
        <button id="playRawBtn" class="secondary" disabled>Play Raw</button>
        <button id="playFiltBtn" class="secondary" disabled>Play Filtered</button>
      </div>

      <div class="status" id="status">Ready.</div>
    </div>

    <div class="plots">
      <div class="plot"><label>Live Spectrogram (filtered)</label><canvas id="spectrogram" width="1024" height="256"></canvas></div>
      <div class="plot"><label>Live Waveform (filtered)</label><canvas id="waveform" width="1024" height="256"></canvas></div>
      <div class="plot" style="grid-column:1/-1;"><label>Magnitude Response</label><canvas id="response" width="1200" height="220"></canvas></div>
      <div class="plot" style="grid-column:1/-1;"><label>Phase Response (deg)</label><canvas id="phase" width="1200" height="180"></canvas></div>
    </div>
  </div>

  <!-- Help -->
  <div id="helpBackdrop" class="backdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <h2>How this works</h2>
      <ul>
        <li><b>HP/LP order</b>: cascades of biquads (2nd-order). Order 4 = two sections. Q values follow Butterworth.</li>
        <li><b>Lowpass Only</b>: skips HP and uses LP only (e.g., de-essing / rumble not needed).</li>
        <li><b>Notch</b>: narrow rejection (e.g., 50/60 Hz). Increase Q to narrow.</li>
        <li><b>WAV sample rate</b>: “Auto” uses the browser’s native rate (often 48 kHz). Choose 16 kHz to resample on save.</li>
        <li><b>Recording</b>: records both raw and filtered streams; use Save to download WAVs.</li>
        <li><b>Phase plot</b>: unwrapped total phase of the active cascade.</li>
      </ul>
      <div class="actions"><button id="helpClose" class="secondary small">Close</button></div>
    </div>
  </div>

  <!-- Theme + Help + SW -->
  <script>
    (function(){
      const root=document.documentElement, btn=document.getElementById('themeBtn');
      const saved=localStorage.getItem('theme'); const prefers=matchMedia('(prefers-color-scheme: light)').matches?'light':'dark';
      root.dataset.theme=saved||prefers; btn.textContent=(root.dataset.theme==='light')?'Dark':'Light';
      btn.addEventListener('click',()=>{ const t=(root.dataset.theme==='dark')?'light':'dark'; root.dataset.theme=t; localStorage.setItem('theme',t); btn.textContent=(t==='light')?'Dark':'Light';});
      const open=()=>{document.getElementById('helpBackdrop').style.display='flex'};
      const close=()=>{document.getElementById('helpBackdrop').style.display='none'};
      document.getElementById('helpBtn').onclick=open; document.getElementById('helpClose').onclick=close;
      document.getElementById('helpBackdrop').addEventListener('click',e=>{ if(e.target.id==='helpBackdrop') close();});
      if('serviceWorker' in navigator){ window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js')); }
    })();
  </script>

  <script src="app.js?v=2" defer></script>
</body>
</html>
